sequenceDiagram
  autonumber
  participant U as Usuario (UI)
  participant API as FastAPI (/ui/chat)
  participant R as Redis (historial)
  participant G as Grafo LangGraph
  participant T as Tools MINSAL
  participant V as Qdrant

  U->>API: 1) "Hola, soy Ana"
  API-->>U: Confirmación de usuario (sin invocar grafo)

  U->>API: 2) "que farmacia hay en traiguén?"
  API->>R: Leer historial (usuario_ana)
  API->>G: invoke({messages})
  G->>G: in_scope ✓ → guardrails ✓ → router=farmacias
  G->>T: getLocales (o fallback)
  G-->>API: format (texto MINSAL)
  API->>R: Persistir turno
  API-->>U: Lista de farmacias

  U->>API: 3) "Que farmacia hay de turno en traiguén?"
  API->>R: Leer historial
  API->>G: invoke
  G->>G: router=turnos (hoy→día actual)
  G->>T: getLocalesTurnos
  G-->>API: format
  API->>R: Persistir turno
  API-->>U: Turnos hoy

  U->>API: 4) "efectos adversos del ibuprofeno"
  API->>R: Historial
  API->>G: invoke
  G->>G: router=meds → by_name
  G->>V: search (Qdrant)
  G-->>API: format (ficha factual)
  API->>R: Persistir
  API-->>U: Ficha ibuprofeno

  U->>API: 5) "¿cada cuánto puedo tomar?"
  API->>G: invoke
  G->>G: guardrails → blocked (dosis)
  G-->>API: policy_message
  API-->>U: Mensaje de política (sin dosis)

  U->>API: 6) "farmacias en Traiguén por Santa Cruz N° 902?"
  API->>G: invoke
  G->>G: router=farmacias + address_mode
  G->>T: getLocales → filtro por comuna + tokens dirección
  G-->>API: format
  API-->>U: Resultados por dirección


